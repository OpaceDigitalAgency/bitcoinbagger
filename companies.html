<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Proxy Companies | BitcoinBagger</title>
    <meta name="description" content="Track public companies holding Bitcoin as treasury assets. Live data on MicroStrategy, Marathon Digital, Tesla, and other Bitcoin proxy stocks.">
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-icon"></div>
            <h2>Loading Companies...</h2>
            <p>Fetching live company data</p>
        </div>
    </div>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-left">
                <a href="index.html" class="nav-brand"><i data-lucide="bitcoin" class="nav-logo"></i><span>BitcoinBagger</span></a>
                <div class="nav-links">
                    <a href="index.html" class="nav-link"><i data-lucide="home"></i><span>Home</span></a>
                    <a href="companies.html" class="nav-link active"><i data-lucide="building-2"></i><span>Companies</span></a>
                    <a href="etfs.html" class="nav-link"><i data-lucide="pie-chart"></i><span>ETFs</span></a>
                </div>
            </div>
            <div class="nav-right">
                <div class="btc-price-display">
                    <span class="btc-label">BTC/USD</span><span id="nav-btc-price" class="btc-price">Loading...</span><span id="nav-btc-change" class="btc-change">--</span>
                </div>
                <button id="theme-toggle" class="theme-toggle"><i data-lucide="moon" id="theme-icon"></i></button>
            </div>
        </div>
    </nav>
    <main class="main-content container">
        <header class="page-header">
            <h1>Bitcoin Proxy Companies</h1>
            <p>Track public companies holding Bitcoin as treasury assets. Monitor live holdings, premiums, and BSP ratios for strategic insights.</p>
            <div class="overview-stats">
                <div class="overview-card"><h3>Total BTC Held</h3><p id="total-btc-held">Loading...</p></div>
                <div class="overview-card"><h3>Combined Value</h3><p id="combined-value">Loading...</p></div>
                <div class="overview-card"><h3>Bitcoin Price</h3><p id="bitcoin-price">Loading...</p></div>
            </div>
        </header>
        <div class="table-section">
            <div class="table-header"><h2>Bitcoin Holdings by Company</h2><select id="sort-select" class="sort-select"><option value="btcHeld">Sort by BTC Holdings</option><option value="btcValue">Sort by BTC Value</option><option value="marketCap">Sort by Market Cap</option><option value="premium">Sort by Premium</option></select></div>
            <div class="table-container"><table id="companies-table" class="data-table"><thead><tr><th>Company</th><th class="text-right">BTC Held</th><th class="text-right">BTC Value</th><th class="text-right">Market Cap</th><th class="text-right">Stock Price</th><th class="text-right">BSP</th><th class="text-right">Premium</th></tr></thead><tbody></tbody></table></div>
        </div>
    </main>
    <script src="public/js/api.js"></script>
    <script src="public/js/utils.js"></script>
    <script>
        // Updated companies.js to use dynamic treasury API
        class CompaniesPage {
            constructor() {
                this.companies = [];
                this.btcPrice = 0;
                this.sortBy = 'btcHeld';
                this.init();
            }

            async init() {
                await this.loadBitcoinPrice();
                await this.loadCompanies();
                this.setupEventListeners();
                this.hideLoadingScreen();
                this.startAutoRefresh();
            }

            async loadBitcoinPrice() {
                try {
                    console.log('Loading Bitcoin price...');
                    const data = await window.bitcoinAPI.fetchBitcoinPrice();
                    console.log('Bitcoin price data:', data);
                    this.btcPrice = data.usd;

                    const priceElement = document.getElementById('bitcoin-price');
                    if (priceElement) {
                        priceElement.textContent = Utils.formatCurrency(data.usd);
                    } else {
                        console.error('bitcoin-price element not found');
                    }

                    // Update nav price display
                    const navPrice = document.getElementById('nav-btc-price');
                    if (navPrice) navPrice.textContent = Utils.formatCurrency(data.usd);
                } catch (error) {
                    console.error('Error loading Bitcoin price:', error);
                }
            }

            async loadCompanies() {
                try {
                    console.log('Loading companies...');
                    // Use the dynamic treasury API with cache busting
                    const response = await fetch('/api/treasuries.php?t=' + Date.now());
                    const data = await response.json();
                    console.log('Companies data:', data);

                    if (data.data) {
                        // Filter for companies only (not ETFs)
                        this.companies = data.data.filter(item => item.type === 'stock');
                        this.updateOverviewStats();
                        this.renderCompaniesTable();
                    }
                } catch (error) {
                    console.error('Error loading companies:', error);
                    this.showError('Failed to load company data');
                }
            }

            updateOverviewStats() {
                const totalBTC = this.companies.reduce((sum, company) => sum + company.btcHeld, 0);
                const combinedValue = totalBTC * this.btcPrice;

                document.getElementById('total-btc-held').textContent = Utils.formatNumber(totalBTC) + ' BTC';
                document.getElementById('combined-value').textContent = Utils.formatCurrency(combinedValue);
            }

            renderCompaniesTable() {
                const tbody = document.querySelector('#companies-table tbody');
                const sortedCompanies = this.getSortedCompanies();

                tbody.innerHTML = sortedCompanies.map(company => {
                    const btcValue = company.btcHeld * this.btcPrice;
                    const marketCap = company.marketCap || 0;
                    const stockPrice = company.stockPrice || 0;
                    const bsp = stockPrice > 0 ? (btcValue / stockPrice).toFixed(2) : 'N/A';
                    const premium = marketCap > 0 && btcValue > 0 ? (((marketCap - btcValue) / btcValue) * 100).toFixed(1) : 'N/A';

                    return `
                        <tr>
                            <td>
                                <div class="company-info">
                                    <div class="company-name">${company.name}</div>
                                    <div class="company-ticker">${company.ticker}</div>
                                    <div class="company-business">${company.businessModel}</div>
                                </div>
                            </td>
                            <td class="text-right">${Utils.formatNumber(company.btcHeld)} BTC</td>
                            <td class="text-right">${Utils.formatCurrency(btcValue)}</td>
                            <td class="text-right">${marketCap > 0 ? Utils.formatCurrency(marketCap) : 'N/A'}</td>
                            <td class="text-right">${stockPrice > 0 ? Utils.formatCurrency(stockPrice) : 'N/A'}</td>
                            <td class="text-right">${bsp}</td>
                            <td class="text-right ${premium !== 'N/A' ? (parseFloat(premium) >= 0 ? 'positive' : 'negative') : ''}">${premium}${premium !== 'N/A' ? '%' : ''}</td>
                        </tr>
                    `;
                }).join('');
            }

            getSortedCompanies() {
                return [...this.companies].sort((a, b) => {
                    switch (this.sortBy) {
                        case 'btcValue':
                            return (b.btcHeld * this.btcPrice) - (a.btcHeld * this.btcPrice);
                        case 'marketCap':
                            return (b.marketCap || 0) - (a.marketCap || 0);
                        case 'premium':
                            const premiumA = this.calculatePremium(a);
                            const premiumB = this.calculatePremium(b);
                            return premiumB - premiumA;
                        case 'btcHeld':
                        default:
                            return b.btcHeld - a.btcHeld;
                    }
                });
            }

            calculatePremium(company) {
                const btcValue = company.btcHeld * this.btcPrice;
                const marketCap = company.marketCap || 0;
                return marketCap > 0 && btcValue > 0 ? ((marketCap - btcValue) / btcValue) * 100 : 0;
            }

            setupEventListeners() {
                document.getElementById('sort-select').addEventListener('change', (e) => {
                    this.sortBy = e.target.value;
                    this.renderCompaniesTable();
                });
            }

            hideLoadingScreen() {
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                }, 1000);
            }

            startAutoRefresh() {
                // Refresh Bitcoin price every 2 minutes
                setInterval(() => this.loadBitcoinPrice(), 120000);

                // Refresh company data every 30 minutes (since it's cached)
                setInterval(() => this.loadCompanies(), 1800000);
            }

            showError(message) {
                const tbody = document.querySelector('#companies-table tbody');
                tbody.innerHTML = `<tr><td colspan="7" class="error-cell">${message}</td></tr>`;
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new CompaniesPage();
        });
    </script>
</body>
</html>
